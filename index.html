<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyOS | v14 (Gemini 2.5)</title>
<style>
  :root { --primary: #2563eb; --secondary: #1e293b; --bg: #f8fafc; --card: #ffffff; --text: #334155; --success: #22c55e; --error: #ef4444; --font: 'Segoe UI', system-ui, sans-serif; }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
  header { background: var(--secondary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
  h1 { margin: 0; font-size: 1.2rem; }
  .nav-tabs { display: flex; gap: 10px; }
  .tab-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
  .tab-btn.active { background: var(--primary); font-weight: bold; }
  main { flex: 1; overflow-y: auto; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; }
  .view { display: none; } .view.active { display: block; }
  .card { background: var(--card); border-radius: 10px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
  .btn { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: 0.2s; }
  .btn:hover { opacity: 0.9; } .btn.secondary { background: #94a3b8; } .btn.danger { background: var(--error); }
  input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #cbd5e1; border-radius: 6px; }
  .quiz-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
  .quiz-item { background: white; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; }
  .quiz-item:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: var(--primary); }
  .delete-quiz { position: absolute; top: 10px; right: 10px; color: #94a3b8; cursor: pointer; font-size: 1.2rem; }
  .option { padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
  .option.selected { border-color: var(--primary); background: #eff6ff; }
  .option.correct { background: #dcfce7; border-color: var(--success); }
  .option.wrong { background: #fee2e2; border-color: var(--error); }
  .feedback { margin-top: 20px; padding: 20px; background: #f0fdf4; border-left: 4px solid var(--success); border-radius: 4px; display: none; }
  .feedback.show { display: block; }
  .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .hidden { display: none; }
</style>
</head>
<body>

<header>
  <h1>ü©∫ StudyOS v14</h1>
  <nav class="nav-tabs">
    <button class="tab-btn active" onclick="showView('library')">Library</button>
    <button class="tab-btn" onclick="showView('generator')">AI Gen</button>
    <button class="tab-btn" onclick="showView('import')">Import</button>
    <button class="tab-btn" onclick="showView('settings')">Settings</button>
  </nav>
</header>

<main>
  <div id="library" class="view active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2>My Quizzes</h2>
      <div>
        <button class="btn" onclick="showView('generator')">+ AI Quiz</button>
        <button class="btn secondary" onclick="showView('import')">Import JSON</button>
      </div>
    </div>
    <div id="quiz-grid" class="quiz-list"></div>
  </div>

  <div id="generator" class="view">
    <div class="card">
      <h2>Generate Quiz (Gemini 2.5 Pro)</h2>
      
      <label>Topic</label>
      <input type="text" id="ai-topic" placeholder="e.g. Sepsis, Shock, Ventilation">
      
      <label>Number of Questions</label>
      <input type="number" id="ai-count" value="10" min="1" max="50">
      
      <label>Mode</label>
      <select id="ai-diff">
        <option value="Comprehensive">Comprehensive (Learn New Material - Easy to Hard)</option>
        <option value="Board-Style">Board-Style (Push to Extreme - Hard Only)</option>
      </select>
      
      <button class="btn" onclick="generateQuiz()" style="width:100%; margin-top:20px;">Generate</button>
      <div id="gen-loader" class="loader"></div>
      <p id="gen-status" style="text-align:center; color:#64748b; margin-top:10px;"></p>
    </div>
  </div>

  <div id="import" class="view">
    <div class="card">
      <h2>Import Quiz</h2>
      <p>Paste raw JSON code here.</p>
      <label>Quiz Title</label>
      <input type="text" id="import-title" placeholder="e.g. Imported Quiz">
      <label>JSON Data</label>
      <textarea id="import-data" rows="10" placeholder='[{"stem": "...", "choices": ...}]' style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-family:monospace;"></textarea>
      <button class="btn" onclick="importQuiz()" style="width:100%; margin-top:20px;">Import to Library</button>
    </div>
  </div>

  <div id="player" class="view">
    <button class="btn secondary" onclick="showView('library')" style="margin-bottom:20px;">‚Üê Back</button>
    <div class="card">
      <h3 id="q-progress">Q 1/10</h3>
      <h2 id="q-text">...</h2>
      <div id="q-options"></div>
      <div id="q-feedback" class="feedback"></div>
      <button id="btn-next" class="btn hidden" onclick="nextQuestion()" style="width:100%; margin-top:20px;">Next</button>
    </div>
  </div>

  <div id="settings" class="view">
    <div class="card">
      <h2>API Key</h2>
      <input type="text" id="api-key" placeholder="Paste AIza... key here">
      <button class="btn" onclick="saveSettings()">Save Key</button>
      <p style="margin-top:10px; font-size:0.9rem; color:#64748b;">Current Key Status: <span id="key-status" style="font-weight:bold">Checking...</span></p>
    </div>
    <div class="card"><button class="btn danger" onclick="localStorage.clear(); location.reload();">Reset App</button></div>
  </div>
</main>

<script>
  const STORE = {
    quizzes: JSON.parse(localStorage.getItem('studyos_quizzes') || '[]'),
    apiKey: localStorage.getItem('studyos_apikey') || '',
  };
  let activeQuiz, currentQIndex, score;

  window.onload = () => {
    document.getElementById('api-key').value = STORE.apiKey;
    document.getElementById('key-status').innerText = STORE.apiKey ? "Key Loaded (Hidden)" : "No Key Found";
    renderLibrary();
  };

  function showView(id) {
    document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const tabIndex = ['library', 'generator', 'import', 'settings'].indexOf(id);
    if(tabIndex > -1) document.querySelectorAll('.tab-btn')[tabIndex].classList.add('active');
  }

  function saveSettings() {
    const key = document.getElementById('api-key').value.trim();
    if(key.length < 10) return alert("Key looks too short. Check your copy/paste.");
    STORE.apiKey = key;
    localStorage.setItem('studyos_apikey', key);
    alert("Key Saved! Try generating now.");
    location.reload();
  }

  // --- GENERATOR (UPDATED FOR GEMINI 2.5) ---
  async function generateQuiz() {
    const topic = document.getElementById('ai-topic').value;
    const count = document.getElementById('ai-count').value;
    const mode = document.getElementById('ai-diff').value;
    
    if(!STORE.apiKey) return alert("NO API KEY: Go to Settings and paste your key.");
    if(!topic) return alert("NO TOPIC: Please enter a medical topic.");

    const loader = document.getElementById('gen-loader');
    const status = document.getElementById('gen-status');
    loader.style.display = 'block';
    status.innerText = "Consulting Gemini 2.5 Pro...";

    let diffInstruction = "";
    if (mode === "Comprehensive") {
        diffInstruction = "Mix of difficulty: 20% Easy, 50% Moderate, 30% Hard. Good for learning new topics.";
    } else {
        diffInstruction = "STRICTLY Moderate to Very Difficult questions only. Board Exam style. No easy questions.";
    }

    const prompt = `Generate a medical quiz about "${topic}". 
    Mode: ${diffInstruction}
    Language: Portuguese (Brazil).
    Format: JSON Array of ${count} objects.
    Structure: [{"id":1, "q":"Question text", "opts":["A","B","C","D"], "correct":0, "expl":"Explanation"}].
    RETURN ONLY RAW JSON.`;

    try {
      // FIX: Updated model to 'gemini-2.5-pro'
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${STORE.apiKey}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });

      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error?.message || 'API Error');
      }

      const data = await response.json();
      const rawText = data.candidates[0].content.parts[0].text;
      const cleanJson = rawText.replace(/```json|```/g, '').trim();
      const questions = JSON.parse(cleanJson);

      const newQuiz = { id: Date.now(), title: topic, date: new Date().toLocaleDateString(), questions: questions };
      STORE.quizzes.push(newQuiz);
      localStorage.setItem('studyos_quizzes', JSON.stringify(STORE.quizzes));
      renderLibrary();
      showView('library');
      alert("Success! Quiz Generated.");

    } catch (e) {
      alert("ERROR: " + e.message);
    } finally {
      loader.style.display = 'none';
      status.innerText = "";
    }
  }

  // --- IMPORT LOGIC ---
  function importQuiz() {
    const title = document.getElementById('import-title').value || "Imported Quiz";
    const rawData = document.getElementById('import-data').value;
    
    try {
        const parsed = JSON.parse(rawData);
        let cleanQuestions = [];

        if(parsed[0].stem) {
            cleanQuestions = parsed.filter(i => i.type && i.type.includes('mcq')).map((item, idx) => {
                const keys = Object.keys(item.choices);
                const values = Object.values(item.choices);
                const correctIdx = keys.indexOf(item.correct);
                let expl = "";
                if(typeof item.explanations === 'object') {
                    expl = Object.entries(item.explanations).map(([k,v]) => `<b>${k}:</b> ${v}`).join('<br><br>');
                } else { expl = "No explanation."; }

                return {
                    id: idx+1,
                    q: item.stem,
                    opts: values,
                    correct: correctIdx,
                    expl: expl
                };
            });
        } else if (parsed[0].q || parsed[0].question_en) {
            cleanQuestions = parsed.map((item, idx) => ({
                id: idx+1,
                q: item.q || item.question_en,
                opts: item.opts || item.answers_en,
                correct: item.correct,
                expl: item.expl || item.explanation_en
            }));
        }

        if(cleanQuestions.length === 0) throw new Error("No questions found.");

        const newQuiz = { id: Date.now(), title: title, date: new Date().toLocaleDateString(), questions: cleanQuestions };
        STORE.quizzes.push(newQuiz);
        localStorage.setItem('studyos_quizzes', JSON.stringify(STORE.quizzes));
        
        document.getElementById('import-title').value = "";
        document.getElementById('import-data').value = "";
        renderLibrary();
        showView('library');
        alert("Import Successful!");

    } catch(e) {
        alert("Import Failed: " + e.message);
    }
  }

  // --- LIBRARY & PLAYER ---
  function renderLibrary() {
    const grid = document.getElementById('quiz-grid');
    grid.innerHTML = STORE.quizzes.length ? STORE.quizzes.map(q => `
      <div class="quiz-item" onclick="startQuiz(${q.id})">
        <div class="delete-quiz" onclick="deleteQuiz(event, ${q.id})">&times;</div>
        <strong>${q.title}</strong><br><small>${q.questions.length} Qs ‚Ä¢ ${q.date}</small>
      </div>`).join('') : '<div style="grid-column:1/-1;text-align:center;color:#94a3b8">No quizzes yet.</div>';
  }
  function deleteQuiz(e, id) { e.stopPropagation(); if(confirm('Delete?')) { STORE.quizzes = STORE.quizzes.filter(q=>q.id!==id); localStorage.setItem('studyos_quizzes', JSON.stringify(STORE.quizzes)); renderLibrary(); } }
  
  function startQuiz(id) { activeQuiz = STORE.quizzes.find(q=>q.id===id); currentQIndex=0; score=0; showView('player'); loadQuestion(); }
  function loadQuestion() {
    const q = activeQuiz.questions[currentQIndex];
    document.getElementById('q-progress').innerText = `Q ${currentQIndex+1}/${activeQuiz.questions.length}`;
    document.getElementById('q-text').innerText = q.q;
    document.getElementById('q-feedback').className = 'feedback';
    document.getElementById('q-feedback').innerHTML = '';
    document.getElementById('btn-next').classList.add('hidden');
    document.getElementById('q-options').innerHTML = q.opts.map((opt,i) => `<div class="option" onclick="check(this,${i})">${opt}</div>`).join('');
  }
  window.check = (el, i) => {
    if(document.querySelector('.option.selected')) return;
    const q = activeQuiz.questions[currentQIndex];
    el.classList.add(i===q.correct ? 'correct' : 'wrong');
    if(i===q.correct) score++; else document.querySelectorAll('.option')[q.correct].classList.add('correct');
    document.getElementById('q-feedback').innerHTML = (i===q.correct?'Correct!':'Wrong.') + `<br>${q.expl}`;
    document.getElementById('q-feedback').classList.add('show');
    document.getElementById('btn-next').classList.remove('hidden');
  }
  function nextQuestion() { if(++currentQIndex < activeQuiz.questions.length) loadQuestion(); else { alert(`Score: ${Math.round(score/activeQuiz.questions.length*100)}%`); showView('library'); } }
</script>
</body>
</html>
